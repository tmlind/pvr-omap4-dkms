#!/bin/sh
# Copyright (C) 2007 Mario Limonciello
# Copyright (C) 2009-2011 Canonical Ltd.
# Copyright (C) 2012 Linaro Ltd.

set -e

PACKAGE_NAME=#DRIVERNAME#
MODULE_NAME=omapdrm_pvr
CVERSION=`dpkg-query -W -f='${Version}' $PACKAGE_NAME | awk -F "-" '{print $1}' | cut -d\: -f2`

INIT_SCRIPT="/etc/init/build-$PACKAGE_NAME.conf"

ARCH=`dpkg --print-architecture`

if [ "$1" = "configure" ]; then

    update-alternatives --force \
        --install /#SYSCONFDIR#/ld.so.conf.d/#DEB_HOST_MULTIARCH#_EGL.conf #DEB_HOST_MULTIARCH#_egl_conf /#LDSOCONF# #ALTPRIORITY# \
        --slave /#BINDIR#/xeglinfo #DEB_HOST_MULTIARCH#_xeglinfo /#PKGBINDIR#/xeglinfo \
        --slave /#BINDIR#/xgles1test1 #DEB_HOST_MULTIARCH#_xgles1test1 /#PKGBINDIR#/xgles1test1 \
        --slave /#BINDIR#/xgles2test1 #DEB_HOST_MULTIARCH#_xgles2test1 /#PKGBINDIR#/xgles2test1 \
        --slave /#BINDIR#/xmultiegltest #DEB_HOST_MULTIARCH#_xmultiegltest /#PKGBINDIR#/xmultiegltest \
        --slave /#BINDIR#/xovg_unit_test #DEB_HOST_MULTIARCH#_xovg_unit_test /#PKGBINDIR#/xovg_unit_test \
        --slave /#LIBDIR#/xorg/modules/drivers/omap_pvr_drv.so #DEB_HOST_MULTIARCH#_pvr_drv /#PKGLIBDIR#/xorg/modules/drivers/omap_pvr_drv.so

    # ldconfig needs to be run immediately as we're changing /etc/ld.so.conf.d/ with
    # alternatives.
    LDCONFIG_NOTRIGGER=y ldconfig

    # Trigger gmenu so that the icons will show up in the menu
    dpkg-trigger --by-package=$PACKAGE_NAME gmenucache || true

    # If the delayed module build feature is enabled
    # i.e. if $DONT_BUILD_MODULE is set to 1
    if [ "${DONT_BUILD_MODULE}1" -eq "11" ]; then
        # Do not build the module and create
        # the Upstart script which will
        # build the module on next boot
        cat > $INIT_SCRIPT <<EOF
# Warning: This file is autogenerated by $PACKAGE_NAME. All changes to this file will be lost.
start on (starting oem-config
          or starting lightdm
          or starting gdm
          or starting kdm
          or starting xdm
          or starting uxlaunch)
task

script
     dkms add -m $PACKAGE_NAME -v $CVERSION
     /usr/lib/dkms/dkms_autoinstaller start || ( rm -f $INIT_SCRIPT && exit 1 )
     modprobe $MODULE_NAME || true
     rm -f $INIT_SCRIPT
end script
EOF
    else
        /usr/lib/dkms/common.postinst $PACKAGE_NAME $CVERSION /usr/share/$PACKAGE_NAME $ARCH $2
    fi
fi

#DEBHELPER#
